import sys
import time
import socket
import threading
import importlib
import RPi.GPIO as GPIO
import infra.config as config

gvar=importlib.import_module(config.gvar)
protocols=importlib.import_module(config.protocols)

				
btnMap=dict(_00000000111111110011101011000101='11', _00000000111111111011101001000101='12', _00000000111111111000001001111101='13', _00000000111111110000001011111101='14', _00000000111111110001101011100101='21', _00000000111111111001101001100101='22', _00000000111111111010001001011101='23', _00000000111111110010001011011101='24', _00000000111111110010101011010101='31', _00000000111111111010101001010101='32', _00000000111111111001001001101101='33', _00000000111111110001001011101101='34', _00000000111111110000101011110101='41', _00000000111111111000101001110101='42', _00000000111111111011001001001101='43', _00000000111111110011001011001101='44', _00000000111111110011100011000111='51', _00000000111111111011100001000111='52', _00000000111111110111100010000111='53', _00000000111111111111100000000111='54', _00000000111111110001100011100111='61', _00000000111111111001100001100111='62', _00000000111111110101100010100111='63', _00000000111111111101100000100111='64', _00000000111111110010100011010111='71', _00000000111111111010100001010111='72', _00000000111111110110100010010111='73', _00000000111111111110100000010111='74', _00000000111111110000100011110111='81', _00000000111111111000100001110111='82', _00000000111111110100100010110111='83', _00000000111111111100100000110111='84', _00000000111111110011000011001111='91', _00000000111111111011000001001111='92', _00000000111111110111000010001111='93', _00000000111111111111000000001111='94', _00000000111111110001000011101111='101', _00000000111111111001000001101111='102', _00000000111111110101000010101111='103', _00000000111111111101000000101111='104', _00000000111111110010000011011111='111', _00000000111111111010000001011111='112', _00000000111111110110000010011111='113', _00000000111111111110000000011111='114')

class ir_rcv(object):
	def __init__(self,parent,info,objid,holder):
		self.parent=parent
		self.pin=4			#get pin from info
		self.sec=[]
		self.last=0
		self.ndinit()
		GPIO.setmode(GPIO.BCM)            # choose BCM or BOARD  
		GPIO.setup(self.pin, GPIO.IN, pull_up_down=GPIO.PUD_UP)
		self.objstring='prelim'
		GPIO.add_event_detect(self.pin, GPIO.BOTH, callback=self.catch)
		self.specInit()
		#self.func=self.lights
	def catch(self, channel):
		self.current=int(time.time()*1000000)
		self.d=self.current-self.last
		self.last=self.current
		self.le=0
		if self.d<10000 and self.le < 67:
			self.sec.append(self.d)
			self.le=self.le+1
		else:
			self.binTrans(self.sec)
			self.sec=[]
			self.le=0

	def binTrans(self, sec):
		self.l=len(sec)
		self.i=3
		self.io='_'
		while self.i < self.l:
			if self.sec[self.i]<1000:
				self.io=self.io+'0'
			elif self.sec[self.i]>1000:
				self.io=self.io+'1'
			self.i=self.i+2
#		print(self.io) #print ir signal
#		print (self.l)
		try: #########################combine the signal comparison of the two dicts
			self.func['_'+btnMap[self.io]]()
			print(btnMap[self.io])
		except KeyError:
			try:
				self.func=self.mapofmaps['_'+btnMap[self.io]]
				print ('rc mode: '+ self.func['name'])
			except KeyError:
#				print ('key not found') #################log as warning?
				pass

	

